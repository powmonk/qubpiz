<div>
  <h1>MC Control Panel</h1>
  
  <div class="quiz-actions">
    <button (click)="showQuizList = !showQuizList" class="select-btn">
      {{ showQuizList ? 'Hide Quiz List' : 'Select Quiz' }}
    </button>
    <button (click)="showNewQuizForm = !showNewQuizForm" class="create-btn">
      {{ showNewQuizForm ? 'Cancel Creation' : 'Create New Quiz' }}
    </button>
  </div>

  <div *ngIf="showQuizList" class="quiz-list">
    <h3>All Quizzes</h3>
    <div *ngIf="allQuizzes.length === 0" class="no-quizzes">
      No quizzes created yet.
    </div>
    <ul>
      <li *ngFor="let quiz of allQuizzes" (click)="selectQuiz(quiz.id)" 
          [class.active]="currentQuiz?.id === quiz.id">
        <div class="quiz-item">
          <strong>{{ quiz.quiz_name }}</strong>
          <span class="quiz-date">{{ quiz.quiz_date | date:'mediumDate' }}</span>
          <button (click)="deleteQuiz(quiz.id, $event)" class="delete-btn-small">Ã—</button>
        </div>
      </li>
    </ul>
  </div>

  <div *ngIf="showNewQuizForm" class="quiz-form">
    <h3>Create New Quiz</h3>
    <label>Quiz Name</label>
    <input 
      type="text" 
      [(ngModel)]="newQuizName" 
      placeholder="e.g., Pub Quiz - October 21st"
    />
    
    <label>Quiz Date</label>
    <input 
      type="date" 
      [(ngModel)]="newQuizDate"
    />
    
    <button (click)="createQuiz()" class="save-btn">Create Quiz</button>
  </div>

  <div *ngIf="currentQuiz" class="current-quiz">
    <h2>{{ currentQuiz.quiz_name }}</h2>
    <p class="quiz-date-display">{{ currentQuiz.quiz_date | date:'fullDate' }}</p>
    
    <div class="game-status-panel">
      <button (click)="toggleGameStatus()"
              [ngClass]="{
                'start-game-btn': currentQuiz.status === 'waiting',
                'end-game-btn': currentQuiz.status === 'active'
              }">
        <span *ngIf="currentQuiz.status === 'waiting'">Start Game & Open Lobby</span>
        <span *ngIf="currentQuiz.status === 'active'">Close Lobby (Game Running)</span>
        <span *ngIf="currentQuiz.status === 'closed'">Re-Open Lobby (Game Running)</span>
      </button>
      <p>Status: <strong>{{ currentQuiz.status | uppercase }}</strong></p>
    </div>
    
    <div class="player-management">
      <h3>Players in Game ({{ players.length }})</h3>
      <div *ngIf="players.length === 0" class="no-players">
        No players have joined yet.
      </div>
      <ul class="player-list">
        <li *ngFor="let player of players">
          <span>{{ player }}</span>
          <button (click)="removePlayer(player)" class="remove-player-btn">Remove</button>
        </li>
      </ul>
      <button (click)="resetGame()" class="reset-btn">Clear All Players</button>
    </div>

    <app-round-manager
      [currentQuizId]="currentQuiz.id"
      [currentDisplayedRoundId]="currentQuiz.current_round_id"
      (roundSelected)="onRoundSelected($event)"
      (displayStateChanged)="handleDisplayStateChanged()">
    </app-round-manager>

    <app-question-manager
      *ngIf="selectedRound"
      [currentRound]="selectedRound">
    </app-question-manager>

    <!-- End Game and Marking Controls Section (Bottom of page) -->
    <div *ngIf="currentQuiz.status === 'closed'" class="bottom-controls">
      <h3>Game Controls</h3>
      <div class="bottom-buttons">
        <button (click)="toggleGameAndMarking()"
                [ngClass]="markingMode ? 'resume-game-btn' : 'end-game-final-btn'">
          <span *ngIf="!markingMode">End Game & Start Marking</span>
          <span *ngIf="markingMode">Resume Game</span>
        </button>
        <button (click)="viewMarkingResults()" class="view-results-btn">
          {{ showResults ? 'Refresh Results' : 'View Marking Results' }}
        </button>
      </div>
      <p class="marking-help" *ngIf="!markingMode">
        When you're done with all rounds, click "End Game & Start Marking" to send all rounds to players for peer marking.
      </p>
      <p class="marking-help" *ngIf="markingMode">
        Players are currently marking answers. Click "View Marking Results" to see scores.
      </p>

      <!-- Results Display -->
      <div *ngIf="showResults" class="results-display">
        <h4>Peer Marking Results</h4>
        <div *ngIf="markingResults.length === 0" class="no-results">
          <p>No marking results yet. Players haven't submitted marks.</p>
        </div>
        <table *ngIf="markingResults.length > 0" class="results-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th>Marked By</th>
              <th>Score</th>
              <th>Percentage</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let result of markingResults; let i = index">
              <td class="rank">{{ i + 1 }}</td>
              <td class="player-name">{{ result.player }}</td>
              <td class="marked-by">{{ result.markedBy }}</td>
              <td class="score">{{ result.score }} / {{ result.possible }}</td>
              <td class="percentage">{{ (result.score / result.possible * 100).toFixed(1) }}%</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div *ngIf="!currentQuiz && !showNewQuizForm && !showQuizList" class="no-selection">
    <p>Select an existing quiz or create a new one to get started.</p>
  </div>
</div>